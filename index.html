<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="dashboard_title">Dashboard - Photo Print Service</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #74ebd5, #acb6e5);
      overflow-x: hidden;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 500px;
      text-align: center;
      position: relative;
      overflow: hidden;
      box-sizing: border-box;
    }
    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(to right, #ff6b6b, #feca57);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    h2 {
      color: #333;
      font-size: 24px;
      margin: 0;
    }
    p {
      color: #666;
      font-size: 16px;
      margin: 10px 0;
    }
    h3 {
      color: #444;
      font-size: 18px;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.1s, background 0.3s;
    }
    button:hover {
      transform: scale(1.02);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .generate-btn, .print-btn {
      background: linear-gradient(to right, #007bff, #00c4ff);
      color: white;
    }
    .generate-btn:hover, .print-btn:hover {
      background: linear-gradient(to right, #0056b3, #0099cc);
    }
    .logout-btn {
      background: linear-gradient(to right, #ff4b4b, #ff7878);
      color: white;
    }
    .logout-btn:hover {
      background: linear-gradient(to right, #cc3a3a, #cc6060);
    }
    #qrcode {
      margin: 20px 0;
      display: flex;
      justify-content: center;
    }
    .language-btn {
      background: linear-gradient(to right, #28a745, #34d058);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: transform 0.1s, background 0.3s;
    }
    .language-btn:hover {
      background: linear-gradient(to right, #218838, #28a745);
      transform: scale(1.1);
    }
    #message {
      margin-top: 10px;
      color: #ff6b6b;
      font-size: 14px;
      word-wrap: break-word;
    }
    @media (max-width: 600px) {
      .container {
        padding: 15px;
        width: 100%;
        max-width: 100%;
        border-radius: 0;
        box-shadow: none;
      }
      h2 {
        font-size: 20px;
      }
      h3 {
        font-size: 16px;
      }
      button {
        font-size: 14px;
        padding: 10px;
      }
      p {
        font-size: 14px;
      }
      #qrcode img {
        width: 150px;
        height: 150px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2 data-i18n="welcome">Welcome, <span id="username"></span></h2>
      <button class="language-btn" onclick="toggleLanguage()">üåê</button>
    </div>
    <p data-i18n="remaining_prints">Remaining Prints: <span id="remainingUses">0</span></p>
    <p data-i18n="printer_status" id="printer_status">No printer bound yet</p>
    <h3 data-i18n="print_photo">Print Photo</h3>
    <button class="print-btn" onclick="printPhoto()" disabled data-i18n="print_photo_btn">Print Photo (Not Implemented)</button>
    <h3 data-i18n="generate_qr">Generate QR Code</h3>
    <button class="generate-btn" onclick="generateQR()" data-i18n="generate_qr_btn">Generate QR Code</button>
    <div id="qrcode"></div>
    <button class="logout-btn" onclick="logout()" data-i18n="logout">Logout</button>
    <p id="message"></p>
  </div>

  <script>
    const translations = {
      zh: {
        dashboard_title: "‰ª™Ë°®Êùø - ÁÖßÁâáÊâìÂç∞ÊúçÂä°",
        welcome: "Ê¨¢ËøéÔºå",
        remaining_prints: "Ââ©‰ΩôÊâìÂç∞Ê¨°Êï∞Ôºö",
        printer_status: "Â∞öÊú™ÁªëÂÆöÊâìÂç∞Êú∫",
        print_photo: "ÊâìÂç∞ÁÖßÁâá",
        print_photo_btn: "ÊâìÂç∞ÁÖßÁâáÔºàÊú™ÂÆûÁé∞Ôºâ",
        generate_qr: "ÁîüÊàê‰∫åÁª¥Á†Å",
        generate_qr_btn: "ÁîüÊàê‰∫åÁª¥Á†Å",
        logout: "ÈÄÄÂá∫ÁôªÂΩï",
        network_error: "ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÂÜçËØïÔºÅ",
        invalid_access: "Êó†ÊïàËÆøÈóÆÔºåËØ∑ÈáçÊñ∞ÁôªÂΩïÔºÅ",
        printer_bound: "ÂΩìÂâçÁªëÂÆöÁöÑÊâìÂç∞Êú∫Ôºö"
      },
      en: {
        dashboard_title: "Dashboard - Photo Print Service",
        welcome: "Welcome, ",
        remaining_prints: "Remaining Prints: ",
        printer_status: "No printer bound yet",
        print_photo: "Print Photo",
        print_photo_btn: "Print Photo (Not Implemented)",
        generate_qr: "Generate QR Code",
        generate_qr_btn: "Generate QR Code",
        logout: "Logout",
        network_error: "Network error, please try again later!",
        invalid_access: "Invalid access, please login again!",
        printer_bound: "Currently bound printer: "
      }
    };

    let currentLang = localStorage.getItem('language') || 'zh'; // ÈªòËÆ§ËØ≠Ë®ÄËÆæÁΩÆ‰∏∫‰∏≠Êñá
    let username = '';
    let remainingUses = 0;
    let qrToken = '';

    // ÂàùÂßãÂåñ Supabase ÂÆ¢Êà∑Á´Ø
    const SUPABASE_URL = 'https://nqapfcosintqipzttflo.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYXBmY29zaW50cWlwenR0ZmxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMzMjIyMzgsImV4cCI6MjA1ODg5ODIzOH0.EekW0qIKeikF6jEAMXDa_RsKWHeMLsj8LKQBqoPLov8';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ‰ªé URL ÂèÇÊï∞‰∏≠Ëé∑Âèñ username Âíå remainingUses
    const urlParams = new URLSearchParams(window.location.search);
    username = urlParams.get('username');
    remainingUses = parseInt(urlParams.get('remainingUses'), 10);

    if (!username || isNaN(remainingUses)) {
      document.getElementById('message').innerText = translations[currentLang].invalid_access;
      setTimeout(() => {
        window.location.href = '/index.html';
      }, 2000);
      return;
    }

    updateLanguage();
    loadUserInfo();

    function toggleLanguage() {
      currentLang = currentLang === 'zh' ? 'en' : 'zh';
      localStorage.setItem('language', currentLang);
      updateLanguage();
      loadUserInfo();
    }

    function updateLanguage() {
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (element.id === 'welcome' || element.id === 'remaining_prints' || element.id === 'printer_status') {
          const span = element.querySelector('span');
          element.innerHTML = translations[currentLang][key] + (span ? span.outerHTML : '');
        } else {
          element.textContent = translations[currentLang][key];
        }
      });
      document.title = translations[currentLang].dashboard_title;
      document.getElementById('welcome').innerHTML = translations[currentLang].welcome + `<span id="username">${username}</span>`;
      document.getElementById('remainingUses').textContent = remainingUses;
    }

    async function loadUserInfo() {
      try {
        const { data: user, error } = await supabase
          .from('membership_applications')
          .select('printer_id, print_count, qr_token')
          .eq('username', username)
          .single();

        if (error || !user) {
          document.getElementById('message').innerText = translations[currentLang].invalid_access;
          setTimeout(() => {
            window.location.href = '/index.html';
          }, 2000);
          return;
        }

        remainingUses = user.print_count || 0;
        document.getElementById('remainingUses').textContent = remainingUses;

        // ÊòæÁ§∫ÊâìÂç∞Êú∫‰ø°ÊÅØ
        if (user.printer_id) {
          const { data: printer, error: printerError } = await supabase
            .from('printers')
            .select('printer_name')
            .eq('printer_id', user.printer_id)
            .single();

          if (printerError || !printer) {
            document.getElementById('printer_status').innerText = translations[currentLang].printer_status;
          } else {
            document.getElementById('printer_status').innerText = translations[currentLang].printer_bound + printer.printer_name;
          }
        } else {
          document.getElementById('printer_status').innerText = translations[currentLang].printer_status;
        }

        // Ê£ÄÊü•Âπ∂ÁîüÊàê qr_token
        qrToken = user.qr_token;
        if (!qrToken) {
          qrToken = `token-${username}-${Date.now()}`;
          const { error: updateError } = await supabase
            .from('membership_applications')
            .update({ qr_token: qrToken })
            .eq('username', username);

          if (updateError) {
            document.getElementById('message').innerText = translations[currentLang].network_error;
            return;
          }
        }
      } catch (error) {
        console.error('Load user info error:', error);
        document.getElementById('message').innerText = translations[currentLang].network_error;
      }
    }

    function generateQR() {
      const qrcodeDiv = document.getElementById('qrcode');
      qrcodeDiv.innerHTML = '';

      if (!qrToken) {
        document.getElementById('message').innerText = translations[currentLang].network_error;
        return;
      }

      const url = `${window.location.origin}/upload.html?username=${encodeURIComponent(username)}&token=${qrToken}`;
      new QRCode(qrcodeDiv, {
        text: url,
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    }

    function printPhoto() {
      document.getElementById('message').innerText = translations[currentLang].print_photo_btn;
    }

    function logout() {
      window.location.href = '/index.html';
    }
  </script>
</body>
</html>
