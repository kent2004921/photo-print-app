<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>裁剪并上传照片</title>
  <style>
    #canvas, #preview {
      max-width: 100%;
      margin-top: 10px;
    }
    #cropBox {
      position: absolute;
      border: 2px dashed red;
      touch-action: none;
    }
    #container {
      position: relative;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h2>上传并裁剪照片</h2>
  <input type="file" id="fileInput" accept="image/*" />
  <div id="container">
    <canvas id="canvas"></canvas>
    <div id="cropBox"></div>
  </div>
  <h3>裁剪预览</h3>
  <canvas id="preview"></canvas>
  <button id="uploadBtn">上传裁剪后的图片</button>

  <script>
    const fileInput = document.getElementById("fileInput");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const cropBox = document.getElementById("cropBox");
    const preview = document.getElementById("preview");
    const uploadBtn = document.getElementById("uploadBtn");

    let img = new Image();
    let startX, startY, offsetX = 50, offsetY = 50;
    let cropWidth = 150, cropHeight = 150;
    let dragging = false;

    const MAX_SIZE = 1024;

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (evt) {
        img.onload = function () {
          let width = img.width;
          let height = img.height;

          if (width > MAX_SIZE || height > MAX_SIZE) {
            const ratio = Math.min(MAX_SIZE / width, MAX_SIZE / height);
            width *= ratio;
            height *= ratio;
          }

          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);

          cropBox.style.width = cropWidth + "px";
          cropBox.style.height = cropHeight + "px";
          cropBox.style.left = offsetX + "px";
          cropBox.style.top = offsetY + "px";
        };
        img.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });

    function updatePreview() {
      const scale = canvas.width / canvas.offsetWidth;
      const sx = offsetX * scale;
      const sy = offsetY * scale;
      const sw = cropWidth * scale;
      const sh = cropHeight * scale;

      preview.width = cropWidth;
      preview.height = cropHeight;
      const pctx = preview.getContext("2d");
      pctx.clearRect(0, 0, preview.width, preview.height);
      pctx.drawImage(canvas, sx, sy, sw, sh, 0, 0, cropWidth, cropHeight);
    }

    function handleMove(clientX, clientY) {
      offsetX = Math.min(
        Math.max(0, clientX - startX),
        canvas.offsetWidth - cropWidth
      );
      offsetY = Math.min(
        Math.max(0, clientY - startY),
        canvas.offsetHeight - cropHeight
      );
      cropBox.style.left = offsetX + "px";
      cropBox.style.top = offsetY + "px";
      requestAnimationFrame(updatePreview);
    }

    cropBox.addEventListener("mousedown", (e) => {
      dragging = true;
      startX = e.clientX - offsetX;
      startY = e.clientY - offsetY;
    });

    document.addEventListener("mousemove", (e) => {
      if (dragging) handleMove(e.clientX, e.clientY);
    });

    document.addEventListener("mouseup", () => dragging = false);

    // 移动端触摸支持
    cropBox.addEventListener("touchstart", (e) => {
      dragging = true;
      const touch = e.touches[0];
      startX = touch.clientX - offsetX;
      startY = touch.clientY - offsetY;
      e.preventDefault();
    });

    document.addEventListener("touchmove", (e) => {
      if (dragging) {
        const touch = e.touches[0];
        handleMove(touch.clientX, touch.clientY);
        e.preventDefault();
      }
    });

    document.addEventListener("touchend", () => dragging = false);

    uploadBtn.addEventListener("click", () => {
      const scale = canvas.width / canvas.offsetWidth;
      const sx = offsetX * scale;
      const sy = offsetY * scale;
      const sw = cropWidth * scale;
      const sh = cropHeight * scale;

      const outputCanvas = document.createElement("canvas");
      outputCanvas.width = cropWidth;
      outputCanvas.height = cropHeight;
      const octx = outputCanvas.getContext("2d");
      octx.drawImage(canvas, sx, sy, sw, sh, 0, 0, cropWidth, cropHeight);

      outputCanvas.toBlob((blob) => {
        const formData = new FormData();
        formData.append("file", blob, "cropped.jpg");

        // 模拟上传（替换为实际上传接口）
        fetch("https://httpbin.org/post", {
          method: "POST",
          body: formData
        })
        .then(res => res.json())
        .then(data => alert("上传成功"))
        .catch(err => alert("上传失败"));
      }, "image/jpeg", 0.9);
    });
  </script>
</body>
</html>
