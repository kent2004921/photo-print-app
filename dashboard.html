<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="title">Dashboard - Photo Print Service</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: #f0f0f0;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 800px;
      text-align: center;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    h2 {
      color: #333;
      font-size: 20px;
      margin: 0;
    }
    h3 {
      color: #333;
      font-size: 18px;
      margin: 10px 0;
    }
    button {
      padding: 8px 16px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      background: #007bff;
      color: white;
    }
    button:hover {
      background: #0056b3;
    }
    .delete-btn {
      background: #dc3545;
    }
    .delete-btn:hover {
      background: #c82333;
    }
    .language-btn {
      background: #28a745;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .language-btn:hover {
      background: #218838;
    }
    .section {
      margin: 20px 0;
      text-align: left;
    }
    .franchisee {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .task {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      background: #f9f9f9;
    }
    .task img.photo-preview {
      width: 60px;
      height: 60px;
      margin-right: 10px;
      object-fit: cover;
      cursor: pointer;
      border-radius: 5px;
    }
    .task img.mask-preview {
      width: 30px;
      height: 30px;
      margin-right: 10px;
      object-fit: cover;
    }
    .task-details {
      flex: 1;
    }
    .task-actions {
      margin-left: auto;
    }
    .hidden {
      display: none;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 90%;
      max-height: 90%;
    }
    .modal-content img {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 5px;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 20px;
      color: white;
      font-size: 30px;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      .task {
        flex-direction: column;
        align-items: flex-start;
      }
      .task-actions {
        margin-left: 0;
        margin-top: 10px;
      }
      .task img.photo-preview {
        width: 50px;
        height: 50px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2 data-i18n="title">Dashboard - Photo Print Service</h2>
      <button class="language-btn" onclick="toggleLanguage()">üåê</button>
    </div>

    <!-- ÁÆ°ÁêÜÂëòÂÆ°Ê†∏ÁïåÈù¢ -->
    <div id="adminSection" class="section hidden">
      <h3 data-i18n="pending_franchisees">Pending Franchisees</h3>
      <div id="pendingList"></div>
    </div>

    <!-- Âä†ÁõüÂïÜÁÆ°ÁêÜÁïåÈù¢ -->
    <div id="franchiseeSection" class="section">
      <h3 data-i18n="welcome">Welcome, Franchisee!</h3>
      <p><span data-i18n="print_quota">Remaining Prints:</span> <span id="printQuota">0</span></p>
      <p><span data-i18n="printer_status">Printer Status:</span> <span id="printerStatus">Unknown</span></p>
      <h3 data-i18n="qr_code">Your QR Code</h3>
      <img id="qrCode" src="" alt="QR Code" onerror="this.src='https://via.placeholder.com/150?text=QR+Code+Failed'">
      <h3 data-i18n="print_tasks">Print Tasks</h3>
      <div id="taskList"></div>
    </div>

    <div id="photoModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">√ó</span>
        <img id="modalPhoto" src="" alt="Photo Preview">
      </div>
    </div>
  </div>

  <script>
    const translations = {
      zh: {
        title: "ÁÆ°ÁêÜÈù¢Êùø - ÁÖßÁâáÊâìÂç∞ÊúçÂä°",
        pending_franchisees: "ÂæÖÂÆ°Ê†∏Âä†ÁõüÂïÜ",
        welcome: "Ê¨¢ËøéÔºåÂä†ÁõüÂïÜÔºÅ",
        print_quota: "Ââ©‰ΩôÊâìÂç∞Ê¨°Êï∞Ôºö",
        printer_status: "ÊâìÂç∞Êú∫Áä∂ÊÄÅÔºö",
        qr_code: "ÊÇ®ÁöÑ‰∫åÁª¥Á†Å",
        print_tasks: "ÊâìÂç∞‰ªªÂä°",
        approve: "ÈÄöËøá",
        task_status_pending: "ÂæÖÊâìÂç∞",
        task_status_printed: "Â∑≤ÊâìÂç∞",
        confirm_print: "Á°ÆËÆ§ÊâìÂç∞",
        delete_task: "Âà†Èô§‰ªªÂä°",
        print_failed: "ÊâìÂç∞Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊâìÂç∞Êú∫Áä∂ÊÄÅÔºÅ"
      },
      en: {
        title: "Dashboard - Photo Print Service",
        pending_franchisees: "Pending Franchisees",
        welcome: "Welcome, Franchisee!",
        print_quota: "Remaining Prints:",
        printer_status: "Printer Status:",
        qr_code: "Your QR Code",
        print_tasks: "Print Tasks",
        approve: "Approve",
        task_status_pending: "Pending",
        task_status_printed: "Printed",
        confirm_print: "Confirm Print",
        delete_task: "Delete Task",
        print_failed: "Printing failed, please check printer status!"
      }
    };

    let currentLang = localStorage.getItem('language') || 'zh';
    updateLanguage();

    function toggleLanguage() {
      currentLang = currentLang === 'zh' ? 'en' : 'zh';
      localStorage.setItem('language', currentLang);
      updateLanguage();
      loadPendingFranchisees();
      loadTasks();
    }

    function updateLanguage() {
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        element.textContent = translations[currentLang][key];
      });
      document.title = translations[currentLang].title;
    }

    // Ê®°ÊãüÊï∞ÊçÆ
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const code = urlParams.get('code');
    const isAdmin = email === 'admin@example.com'; // Ê®°ÊãüÁÆ°ÁêÜÂëò

    // Ê®°Êãü print_jobs Êï∞ÊçÆÔºà‰ªé upload.html ÂÖ±‰∫´Ôºâ
    let printJobs = window.printJobs || [
      { id: 1, photoUrl: 'https://via.placeholder.com/50', type: 'ÊëáÊëá‰πê', mask: 'assets/mask_shake.png', status: 'pending' }
    ];

    // ÊòæÁ§∫ÁÆ°ÁêÜÂëòÊàñÂä†ÁõüÂïÜÁïåÈù¢
    if (isAdmin) {
      document.getElementById('adminSection').classList.remove('hidden');
      document.getElementById('franchiseeSection').classList.add('hidden');
      loadPendingFranchisees();
    } else {
      document.getElementById('adminSection').classList.add('hidden');
      document.getElementById('franchiseeSection').classList.remove('hidden');
      loadFranchiseeData();
    }

    function loadPendingFranchisees() {
      // Ê®°ÊãüÂæÖÂÆ°Ê†∏Âä†ÁõüÂïÜÊï∞ÊçÆ
      const pendingFranchisees = [
        { id: 1, name: 'wing', email: 'kwn998@gmail.com', phone: '0614845451' }
      ];
      const pendingList = document.getElementById('pendingList');
      pendingList.innerHTML = '';
      pendingFranchisees.forEach(franchisee => {
        const div = document.createElement('div');
        div.className = 'franchisee';
        div.innerHTML = `
          <p>Name: ${franchisee.name}</p>
          <p>Email: ${franchisee.email}</p>
          <p>Phone: ${franchisee.phone}</p>
          <button onclick="approveFranchisee(${franchisee.id})" data-i18n="approve">Approve</button>
        `;
        pendingList.appendChild(div);
      });
      updateLanguage();
    }

    function approveFranchisee(id) {
      // Ê®°ÊãüÈÄöËøáÂÆ°Ê†∏ÔºåÂÆûÈôÖ‰ºöÊõ¥Êñ∞ Supabase
      alert('Franchisee approved! Unique code: FRANCHISEE_abc123');
      loadPendingFranchisees();
    }

    function loadFranchiseeData() {
      // Ê®°ÊãüÂä†ÁõüÂïÜÊï∞ÊçÆ
      document.getElementById('printQuota').innerText = 10;
      document.getElementById('printerStatus').innerText = 'Unknown'; // ÂêéÁª≠Áî® Epson API
      const qrCode = document.getElementById('qrCode');
      // Âä®ÊÄÅËé∑ÂèñÂΩìÂâçÂüüÂêçÔºåÈÅøÂÖçÁ°¨ÁºñÁ†Å
      const baseUrl = window.location.origin;
      qrCode.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(`${baseUrl}/upload.html?code=${code}`)}`;
      loadTasks();
    }

    function loadTasks() {
      const taskList = document.getElementById('taskList');
      taskList.innerHTML = '';
      printJobs.forEach(task => {
        const div = document.createElement('div');
        div.className = 'task';
        div.innerHTML = `
          <img src="${task.photoUrl}" alt="Photo" class="photo-preview" onclick="openModal('${task.photoUrl}')" onerror="this.src='https://via.placeholder.com/60?text=Photo+Failed'">
          <div class="task-details">
            <p>Type: <span class="task-type">${task.type}</span></p>
            <p>Mask: <img src="${task.mask || 'https://via.placeholder.com/30?text=Mask+Failed'}" alt="Mask" class="mask-preview"></p>
            <p>Status: <span class="task-status" data-i18n="task_status_${task.status}">${translations[currentLang][`task_status_${task.status}`]}</span></p>
          </div>
          <div class="task-actions">
            ${task.status === 'pending' ? `<button onclick="confirmPrint(${task.id})" data-i18n="confirm_print">Confirm Print</button>` : ''}
            <button class="delete-btn" onclick="deleteTask(${task.id})" data-i18n="delete_task">Delete Task</button>
          </div>
        `;
        taskList.appendChild(div);
      });
      updateLanguage();
    }

    function confirmPrint(id) {
      const task = printJobs.find(t => t.id === id);
      if (task) {
        try {
          // Ê®°ÊãüË∞ÉÁî® Epson API ÊâìÂç∞
          console.log('Sending to printer:', task.photoUrl);
          // ÂÆûÈôÖ‰ºöË∞ÉÁî® Epson API /print Á´ØÁÇπ
          alert('Printing task ' + id);
          // Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅ
          task.status = 'printed';
          // ÂÆûÈôÖ‰ºöÊõ¥Êñ∞ Supabase
          window.printJobs = printJobs; // Êõ¥Êñ∞ÂÖ®Â±ÄÂèòÈáè
          loadTasks();
        } catch (error) {
          alert(translations[currentLang].print_failed);
          console.error('Print error:', error);
        }
      }
    }

    function deleteTask(id) {
      if (confirm(translations[currentLang].delete_task + '?')) {
        printJobs = printJobs.filter(task => task.id !== id);
        window.printJobs = printJobs; // Êõ¥Êñ∞ÂÖ®Â±ÄÂèòÈáè
        loadTasks();
      }
    }

    function openModal(photoUrl) {
      const modal = document.getElementById('photoModal');
      const modalPhoto = document.getElementById('modalPhoto');
      modalPhoto.src = photoUrl;
      modal.style.display = 'flex';
    }

    function closeModal() {
      const modal = document.getElementById('photoModal');
      modal.style.display = 'none';
    }

    // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
    window.onclick = function(event) {
      const modal = document.getElementById('photoModal');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    };
  </script>
</body>
</html>
